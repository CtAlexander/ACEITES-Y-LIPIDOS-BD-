<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aceites y L√≠pidos BD</title>
    <style>
        /* Marca de agua */
        .marca-de-agua {
            position: fixed;
            bottom: 0;
            right: 0;
            margin: 10px;
            opacity: 0.2;
            font-size: 50px;
            color: black;
            pointer-events: none;
        }

        /* Body Styling */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #2a3c4f;
            color: #d0d0d0;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5%;
            background-size: cover;
            position: relative;
        }

        /* Onda verde en la pared izquierda */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, #00b954, transparent 70%);
            opacity: 0.15;
            z-index: -1;
        }

        /* Info Container */
        .info-container {
            color: #ffffff;
            max-width: 500px;
            margin-right: 5%;
        }

        .info-container h1 {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00b954;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .info-container ul {
            list-style-type: none;
            padding: 0;
        }

        .info-container li {
            margin-bottom: 20px;
            font-size: 18px;
        }

        .info-container li:before {
            content: '‚úîÔ∏è';
            color: #00ed64;
            margin-right: 10px;
        }

        /* Login/Signin Containers */
        .login-container, .signin-container {
            background-color: #ffffff;
            padding: 35px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            color: #000000;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        h1 {
            color: #00b954;
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            color: #333;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus {
            border-color: #00b954;
            outline: none;
        }

        /* Bot√≥n */
        .button {
            width: 100%;
            padding: 15px;
            background-color: #00b954;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #009847;
        }

        /* Loading Container */
        .loading-container {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #00ed64;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Menu Container */
        .menu-container {
            display: none;
            background-color: transparent;
            padding: 40px;
            box-sizing: border-box;
            color: #000000;
            width: 100vw;
            height: 100vh;
            overflow-y: auto;
        }

        /* Tabs */
        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .tabs div {
            padding: 10px 20px;
            background-color: #4b5e6e;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .tabs div.active {
            background-color: #00b954;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 16px;
            color: #333;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table td {
            color: #00b954;
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        /* Links */
        .file-link {
            color: #00b954;
            text-decoration: none;
            transition: text-decoration 0.2s;
        }

        .file-link:hover {
            text-decoration: underline;
        }

        .no-file {
            color: #a9a9a9;
        }

        /* Switch Container */
        .switch-container {
            margin-top: 20px;
            text-align: center;
        }

        .switch-container a {
            color: #00b954;
            cursor: pointer;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .switch-container a:hover {
            color: #009847;
        }

        /* User Box */
        .user-box {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: #00b954;
            color: #ffffff;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        .user-box:hover {
            background-color: #009847;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: #2a3c4f;
            border-radius: 8px;
            width: 200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            color: #ffffff;
            font-size: 14px;
            z-index: 1000;
        }

        .dropdown-menu a {
            display: block;
            padding: 10px 15px;
            color: #ffffff;
            text-decoration: none;
            border-bottom: 1px solid #444;
        }

        .dropdown-menu a:hover {
            background-color: #00b954;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        /* Contenedor principal del organigrama */
        .organigrama-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

/* Nuevo bot√≥n de tres puntos */
        .three-dots-menu {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            cursor: pointer;
        }

        .three-dots-dropdown {
            display: none;
            position: absolute;
            top: 50px;
            left: 20px;
            background-color: #2a3c4f;
            color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .three-dots-dropdown a {
            display: block;
            padding: 10px 15px;
            color: #ffffff;
            text-decoration: none;
            border-bottom: 1px solid #444;
        }

        .three-dots-dropdown a:hover {
            background-color: #00b954;
        }

        .three-dots-dropdown a:last-child {
            border-bottom: none;
        }

       <style>
    /* Estilo general del modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        backdrop-filter: blur(8px);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: #ffffff;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
    }

    .modal-content h2 {
        margin-bottom: 20px;
        font-size: 24px;
        color: #00b954;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 1px;
    }

    .modal-content ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .modal-content ul li {
        margin: 15px 0;
    }

    .modal-content ul li a {
        text-decoration: none;
        font-size: 18px;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        border: 2px solid #00b954;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .modal-content ul li a:hover {
        background: #00b954;
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .modal-content ul li a img {
        margin-right: 10px;
    }

    .modal-content .close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 20px;
        color: #333;
        cursor: pointer;
        font-weight: bold;
        transition: color 0.3s ease;
    }

    .modal-content .close:hover {
        color: #00b954;
    }
/* Estilo del bot√≥n */
#normasIsoButton {
    background-color: #28a745; /* Color verde principal */
    color: #FFFFFF; /* Texto blanco */
    font-family: 'Arial', sans-serif; /* Fuente profesional */
    font-size: 14px; /* Tama√±o del texto m√°s peque√±o */
    padding: 10px 15px; /* Espaciado interno reducido */
    border: none; /* Sin borde */
    border-radius: 6px; /* Bordes redondeados */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Sombra m√°s peque√±a */
    cursor: pointer; /* Cambia el cursor al pasar */
    display: inline-block; /* Mantenerlo en l√≠nea */
    text-align: center; /* Centrar el contenido */
    transition: background-color 0.3s, box-shadow 0.3s; /* Efectos suaves */
    position: absolute; /* Posicionamiento absoluto */
    top: 20px; /* Despegado de la parte superior */
    right: 80px; /* Separado 50px de la esquina derecha */
}

/* Hover del bot√≥n */
#normasIsoButton:hover {
    background-color: #218838; /* Verde m√°s oscuro al pasar */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Aumenta la sombra */
}

/* Activo al presionar */
#normasIsoButton:active {
    background-color: #1e7e34; /* Verde m√°s intenso */
    box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2); /* Reduce la sombra */
}

#pdfModal iframe {
    border: none;
}

.search-container {
    margin: 20px 0;
    display: flex;
    gap: 10px;
    align-items: center;
}

#searchInput {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    flex-grow: 1;
}

#searchButton {
    padding: 10px 20px;
    background-color: #00b954;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#searchButton:hover {
    background-color: #009847;
}

.green-button {
    background-color: #28a745; /* Verde brillante */
    color: white; /* Texto blanco */
    border: none; /* Sin bordes */
    padding: 10px 20px; /* Espaciado interno */
    font-size: 16px; /* Tama√±o de fuente */
    font-weight: bold; /* Negrita */
    border-radius: 5px; /* Bordes redondeados */
    cursor: pointer; /* Cambia el cursor al pasar sobre el bot√≥n */
    transition: background-color 0.3s ease; /* Animaci√≥n al pasar el rat√≥n */
}

.green-button:hover {
    background-color: #218838; /* Verde m√°s oscuro al pasar el rat√≥n */
}

.green-button:active {
    background-color: #1e7e34; /* Verde a√∫n m√°s oscuro al hacer clic */
}



    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
</head>
<body>

<div id="pdfModal" class="modal">
    <div class="modal-content" style="width: 90%; height: 90%; max-width: 1200px; max-height: 800px;">
        <span class="close" id="closePdfModal">&times;</span>
        <h2>Normas ISO</h2>

        <!-- Selector de Normas -->
        <select id="normasSelector">
            <option value="iso9001">ISO 9001:2015</option>
            <option value="iso22000">ISO 22000:2018</option>
        </select>

        <!-- Buscador en el documento -->
        <div class="search-container" style="margin: 20px 0; display: flex; gap: 10px;">
            <input type="text" id="searchInput" placeholder="Buscar en el documento" style="flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <button id="searchButton" style="padding: 10px 20px; background-color: #00b954; color: white; border: none; border-radius: 5px; cursor: pointer;">Buscar</button>
        </div>

        <div style="margin: 20px 0; display: flex; justify-content: center; gap: 20px;">
    <button id="prevMatchButton" style="padding: 10px; font-size: 18px;">‚¨ÖÔ∏è Anterior</button>
    <button id="nextMatchButton" style="padding: 10px; font-size: 18px;">‚û°Ô∏è Siguiente</button>
</div>
<div id="pdfViewerContainer" style="width: 100%; height: auto; overflow-y: auto;"></div>

    </div>
</div>








    <!-- Contenedor de usuario y men√∫ desplegable -->
    <div class="user-box" id="user-box">üë§</div>
      <div class="user-box" id="normasIsoButton">üìú Normas ISO</div>
    <div class="dropdown-menu" id="dropdown-menu">
        <a href="#" id="viewProfile">Ver mi perfil</a>
        <a href="#">Administrar perfil</a>
        <a href="#" id="openOrgChart">Ver mi puesto y responsabilidades</a>
        <a href="#" id="logout">Cerrar sesi√≥n</a>
    </div>
    <div class="marca-de-agua">Œ±4</div>

    <!-- Modal para el organigrama -->
    <div id="orgChartModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeOrgChart">&times;</span>
            <h2>Organigrama</h2>
            <img src="https://firebasestorage.googleapis.com/v0/b/YOUR_PROJECT_ID.appspot.com/o/Imagen%20de%20WhatsApp%202024-10-31%20a%20las%2023.40.09_c810af33.jpg?alt=media" alt="Organigrama" style="width: 100%;">
        </div>
    </div>

   
  
  <!-- Modal para el perfil de usuario -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeProfile">&times;</span>
            <h2>Mi Perfil</h2>
            <p><strong>Nombre:</strong> <span id="userName"></span></p>
            <p><strong>Apellido:</strong> <span id="userLastName"></span></p>
            <p><strong>Rol:</strong> <span id="userRole"></span></p>
            <p><strong>Correo Electr√≥nico:</strong> <span id="userEmail"></span></p>
        </div>
    </div>

    <!-- Contenedor de la informaci√≥n -->
    <div class="info-container" id="info-container">
        <h1>Aceites y L√≠pidos BD</h1>
        <ul>
            <li>
                <p><strong>Pol√≠tica de calidad y inocuidad</strong><br>
                Nos comprometemos a proveer aceites y mantecas comestibles desarrollando y adecuando las formulaciones de nuevos productos mediante el cumplimiento de las regulaciones nacionales.</p>
            </li>
            <li>
                <p>Gesti√≥n de los impactos del cambio clim√°tico en nuestros procesos y resultados, y comunicaci√≥n con todas las partes interesadas para satisfacer sus necesidades y expectativas y lograr la mejora continua.</p>
            </li>
            <li>
                <p>Asimismo otorgamos asesor√≠a para el manejo de nuestra gama de productos y desarrollos, generando total confianza y satisfacci√≥n plena en nuestros clientes.</p>
            </li>
        </ul>
    </div>

    <!-- Contenedor de login y registro -->
    <div class="login-container" id="register-screen">
        <h1>Crear cuenta</h1>
        <input type="text" id="nombre" placeholder="Nombre" required>
        <input type="text" id="apellido" placeholder="Apellido" required>
        <input type="text" id="rol" placeholder="Rol" required>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="password" placeholder="Contrase√±a" required>
        <button class="button" id="registerBtn">Crear cuenta</button>
        <div class="switch-container">
            <p>¬øYa tienes cuenta? <a id="switchToSignIn">Iniciar sesi√≥n</a></p>
        </div>
    </div>

    <div class="signin-container" id="signin-screen" style="display: none;">
        <h1>Iniciar sesi√≥n</h1>
        <input type="email" id="loginEmail" placeholder="Correo Electr√≥nico" required>
        <input type="password" id="loginPassword" placeholder="Contrase√±a" required>
        <button class="button" id="loginBtn">Iniciar sesi√≥n</button>
        <div class="switch-container">
            <p>¬øNo tienes cuenta? <a id="switchToRegister">Crear cuenta</a></p>
        </div>
    </div>

    <div class="loading-container" id="loading-screen">
        <div class="loader"></div>
        <p>Cargando...</p>
    </div>

<div class="menu-container" id="menu-screen">
    <h1>ACEITES Y LIPIDOS BD TE DA LA BIENVENIDA</h1>

    <!-- Pesta√±as de navegaci√≥n -->
    <div class="tabs">
            <div id="tab-home" class="active">Inicio</div>
            <div id="tab-lists">Listas</div>
            <div id="tab-files">Archivos</div>
            <div id="tab-settings">Configuraci√≥n</div>
        </div>


    <!-- Contenido de Inicio -->
    <div id="home" class="tab-content active">
        <h2></h2>
        <p></p>
        <div class="info-container">
            <li>
                <p><strong>Objetivo:</strong><br>Evaluar la documentaci√≥n y el grado de implementaci√≥n del 
                    Sistema de An√°lisis de Peligros y Puntos Cr√≠ticos de Control
                    de la organizaci√≥n as√≠ como el cumplimiento 
                    de requisitos legales aplicables.</p>
            </li>
            <li>
                <p><strong>Alcance:</strong><br>
                    Formulaci√≥n de aceites vegetales
                    para la industria de alimentos, 
                    comercializaci√≥n de ingredientes para 
                    la industria de alimentos.</p>
            </li>
        </div>
        <!-- Bot√≥n para cargar el archivo HACCP -->
        <button id="btn-haccp" class="green-button">Manual HACCP
</button>
        <!-- Contenedor para mostrar el PDF -->
        <div id="pdf-container" style="display: none; margin-top: 20px;">
            <iframe id="pdf-viewer" style="width: 100%; height: 600px; border: none;"></iframe>
        </div>
    </div>

    
    
        

        <div id="lists" class="tab-content">
            <h2>Lista Maestra</h2>
            <div class="dropdown-menu" id="listsDropdownMenu" style="display: block;">
                <a href="#" onclick="showListContent('documentada')">Informaci√≥n Documentada Mantenida</a>
                <a href="#" onclick="showListContent('externos')">Documentos Externos</a>
                <a href="#" onclick="showListContent('registros')">Registros</a>
                <a href="#" onclick="showListContent('perfil')">Perfil Funcional</a>
                <a href="#" onclick="showListContent('responsabilidades')">Responsabilidades</a> 
                <a href="#" onclick="showListContent('Procesos')">Procesos</a>
            </div>
            <div id="list-content">
            </div>
        </div>

       <!-- Men√∫ de tres puntos -->
 <div class="three-dots-menu" id="threeDotsMenu">‚ãÆ</div>
    <div class="three-dots-dropdown" id="threeDotsDropdown" style="display: none;">
        <a href="#" id="nonConformities">No conformidades</a>
        <a href="#" id="directiveDecisions">Decisiones directivas</a>
        <a href="#" id="correctiveActions">Acciones correctivas</a>
        <a href="#" id="otherOptions">Otras Opciones</a> <!-- Nueva opci√≥n -->
    </div>



        <div id="files" class="tab-content">
            <h2>Archivo</h2>
            <input type="file" id="fileInput" />
            <button class="button" id="uploadBtn">Subir Archivo</button>
            
            <table>
                <thead>
                    <tr>
                        <th>T√≠tulo</th>
                        <th>C√≥digo</th>
                        <th>Archivo</th>
                    </tr>
                </thead>
                <tbody id="fileTableBody">
                </tbody>
            </table>
        </div>

        <div id="settings" class="tab-content">
            <h2>Configuraci√≥n</h2>
            <p>Aqu√≠ se configurar√°n los ajustes del sistema.</p>
        </div>
    </div>

    <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyD323PEVx7xnnBWpMr2usOEEFQQ20YUcD8",
    authDomain: "plataforma-39bde.firebaseapp.com",
    databaseURL: "https://plataforma-39bde-default-rtdb.firebaseio.com",
    projectId: "plataforma-39bde",
    storageBucket: "plataforma-39bde.appspot.com",
    messagingSenderId: "313253115880",
    appId: "1:313253115880:web:fcaf513b16c4f892ae965d",
    measurementId: "G-D959K30F9R"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
// Variables globales
let pdfDocument = null; // Documento PDF cargado
let currentPage = 1; // P√°gina actual
let currentMatches = []; // Coincidencias actuales
let currentMatchIndex = -1; // √çndice de la coincidencia actual
const pdfViewerContainer = document.getElementById("pdfViewerContainer");

// Archivos de PDF en Firebase Storage
const pdfFiles = {
    iso9001: "normas/NORMA_ISO_9001-2015_Req.PDF",
    iso22000: "normas/ISO-22000-2018.pdf",
};

// Obtener la URL del PDF desde Firebase Storage
async function getPdfUrl(filePath) {
    const fileRef = ref(storage, filePath);
    try {
        const url = await getDownloadURL(fileRef);
        return url;
    } catch (error) {
        console.error(`Error al obtener la URL de ${filePath}:`, error);
        alert("No se pudo cargar el archivo PDF. Intenta de nuevo m√°s tarde.");
        return null;
    }
}

// Renderizar una p√°gina en un canvas
async function renderPage(pageNumber, searchTerm = null) {
    const page = await pdfDocument.getPage(pageNumber);
    const viewport = page.getViewport({ scale: 1.5 });

    // Crear canvas para la p√°gina
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    canvas.style.marginBottom = "20px";

    // Renderizar el PDF en el canvas
    const renderContext = {
        canvasContext: context,
        viewport: viewport,
    };
    await page.render(renderContext).promise;

    // Agregar el canvas al contenedor
    pdfViewerContainer.appendChild(canvas);

    // Si hay un t√©rmino de b√∫squeda, subrayar coincidencias
    if (searchTerm) {
        return underlineFullWords(page, viewport, searchTerm, context, pageNumber);
    }

    return [];
}

// Subrayar texto coincidente en la p√°gina
async function underlineFullWords(page, viewport, searchTerm, context, pageNumber) {
    const textContent = await page.getTextContent();
    const scale = viewport.scale;
    const matches = [];

    textContent.items.forEach((item) => {
        const text = item.str;

        if (text.toLowerCase().includes(searchTerm.toLowerCase())) {
            // Posici√≥n y dimensiones del texto
            const transform = item.transform;
            const x = transform[4]; // Posici√≥n X
            const y = transform[5]; // Posici√≥n Y
            const width = context.measureText(text).width * scale; // Ancho de la palabra completa
            const height = item.height * scale; // Altura de la palabra

            // Dibujar un rect√°ngulo amarillo debajo de la palabra coincidente
            context.fillStyle = "rgba(255, 255, 0, 0.6)";
            context.fillRect(x * scale, viewport.height - y * scale - height, width, height);

            // Guardar la posici√≥n de la coincidencia
            matches.push({ page: pageNumber, x: x * scale, y: viewport.height - y * scale, width, height });
        }
    });

    return matches;
}

// Cargar el PDF y renderizar sus p√°ginas
async function loadPdfAndInitializeViewer(norma) {
    const filePath = pdfFiles[norma];
    if (filePath) {
        const pdfUrl = await getPdfUrl(filePath);
        if (pdfUrl) {
            pdfViewerContainer.innerHTML = ""; // Limpiar contenedor
            pdfDocument = await pdfjsLib.getDocument(pdfUrl).promise;

            // Renderizar todas las p√°ginas
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                await renderPage(i);
            }
           
        } else {
            alert("Error al cargar el archivo seleccionado.");
        }
    } else {
        alert("No se encontr√≥ el archivo para la norma seleccionada.");
    }
}

// Ejecutar la b√∫squeda y subrayar las coincidencias
const searchButton = document.getElementById("searchButton");
const searchInput = document.getElementById("searchInput");
const prevMatchButton = document.getElementById("prevMatchButton");
const nextMatchButton = document.getElementById("nextMatchButton");

searchButton.addEventListener("click", async () => {
    const searchTerm = searchInput.value.trim();
    if (!searchTerm) {
        alert("Ingresa una palabra para buscar.");
        return;
    }

    if (!pdfDocument) {
        alert("Primero debes cargar un documento.");
        return;
    }

    // Volver a renderizar las p√°ginas con subrayado y obtener coincidencias
    pdfViewerContainer.innerHTML = ""; // Limpiar contenedor
    currentMatches = []; // Reiniciar coincidencias
    for (let i = 1; i <= pdfDocument.numPages; i++) {
        const matches = await renderPage(i, searchTerm);
        currentMatches = currentMatches.concat(matches);
    }

    if (currentMatches.length > 0) {
        alert(`Se encontraron ${currentMatches.length} coincidencias.`);
        currentMatchIndex = 0;
        goToMatch(currentMatchIndex);
    } else {
        alert("No se encontraron coincidencias.");
    }
});

// Navegar a una coincidencia espec√≠fica
function goToMatch(index) {
    const match = currentMatches[index];
    if (!match) return;

    // Cambiar a la p√°gina de la coincidencia
    pdfViewerContainer.innerHTML = ""; // Limpiar contenedor
    renderPage(match.page).then(() => {
        const canvas = pdfViewerContainer.querySelector("canvas");
        const context = canvas.getContext("2d");

        // Resaltar la coincidencia actual
        context.strokeStyle = "red";
        context.lineWidth = 2;
        context.strokeRect(match.x, match.y - match.height, match.width, match.height);
    });
}

// Bot√≥n "Anterior"
prevMatchButton.addEventListener("click", () => {
    if (currentMatches.length === 0) return;
    currentMatchIndex = (currentMatchIndex - 1 + currentMatches.length) % currentMatches.length;
    goToMatch(currentMatchIndex);
});

// Bot√≥n "Siguiente"
nextMatchButton.addEventListener("click", () => {
    if (currentMatches.length === 0) return;
    currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
    goToMatch(currentMatchIndex);
});

// Cargar el PDF inicial (por defecto ISO 9001)
loadPdfAndInitializeViewer("iso9001");


// Cambiar PDF seg√∫n la norma seleccionada
if (normasSelector) {
    normasSelector.addEventListener("change", (e) => {
        const norma = e.target.value;
        loadPdfAndInitializeViewer(norma);
    });
}

// Abrir modal de Normas ISO
if (normasIsoButton) {
    normasIsoButton.addEventListener("click", () => {
        pdfModal.style.display = "flex";
        loadPdfAndInitializeViewer("iso9001"); // Cargar ISO 9001 por defecto
    });
}



// Obtener el modal y el bot√≥n de cerrar
const pdfModal = document.getElementById("pdfModal");
const closePdfModal = document.getElementById("closePdfModal");

// Funci√≥n para cerrar el modal
function closeModal() {
    pdfModal.style.display = "none";
}



// Cerrar el modal al hacer clic en la X
closePdfModal.addEventListener("click", closeModal);

// Cerrar el modal al hacer clic fuera del contenido
window.addEventListener("click", (event) => {
    if (event.target === pdfModal) {
        closeModal();
    }
});








        async function loadOrgChartImage() {
            const storageRef = ref(storage, 'Imagen de WhatsApp 2024-10-31 a las 23.40.09_c810af33.jpg');
            const url = await getDownloadURL(storageRef);
            document.querySelector("#orgChartModal img").src = url;
        }

        document.getElementById("openOrgChart").addEventListener("click", () => {
            loadOrgChartImage();
            document.getElementById("orgChartModal").style.display = "block";
        });

        document.getElementById("closeOrgChart").addEventListener("click", () => {
            document.getElementById("orgChartModal").style.display = "none";
        });

        window.addEventListener("click", (event) => {
            if (event.target == document.getElementById("orgChartModal")) {
                document.getElementById("orgChartModal").style.display = "none";
            }
        });

        document.getElementById("user-box").addEventListener("click", () => {
            const dropdownMenu = document.getElementById("dropdown-menu");
            dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
        });

        window.addEventListener("click", (event) => {
            if (!event.target.matches("#user-box")) {
                document.getElementById("dropdown-menu").style.display = "none";
            }
        });

        async function extractCodeFromPDF(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async function () {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let extractedText = '';
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        textContent.items.forEach((item) => {
                            extractedText += item.str + ' ';
                        });
                    }
                    const codeMatch = extractedText.match(/REG-\d{4}-\d{2}/);
                    resolve(codeMatch ? codeMatch[0] : "C√≥digo no encontrado");
                };
                fileReader.onerror = () => reject("Error al leer el PDF");
                fileReader.readAsArrayBuffer(file);
            });
        }

        document.getElementById('registerBtn').addEventListener('click', async () => {
            const nombre = document.getElementById('nombre').value;
            const apellido = document.getElementById('apellido').value;
            const rol = document.getElementById('rol').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!nombre || !apellido || !rol || !email || !password) {
                alert('Por favor complete todos los campos.');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, "users", user.uid), {
                    nombre: nombre,
                    apellido: apellido,
                    rol: rol,
                    email: email
                });

                showLoadingScreen();
            } catch (error) {
                console.error('Error al registrar usuario:', error.message);
                alert('Error al registrar usuario: ' + error.message);
            }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Por favor ingrese su correo electr√≥nico y contrase√±a.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showLoadingScreen();
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error.message);
                alert('Error al iniciar sesi√≥n: ' + error.message);
            }
        });

        function showLoadingScreen() {
            document.getElementById('register-screen').style.display = 'none';
            document.getElementById('signin-screen').style.display = 'none';
            document.getElementById('info-container').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';

            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('menu-screen').style.display = 'block';
                loadFiles();
            }, 5000);
        }

        document.getElementById('switchToSignIn').addEventListener('click', () => {
            document.getElementById('register-screen').style.display = 'none';
            document.getElementById('signin-screen').style.display = 'block';
        });

        document.getElementById('switchToRegister').addEventListener('click', () => {
            document.getElementById('signin-screen').style.display = 'none';
            document.getElementById('register-screen').style.display = 'block';
        });

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor seleccione un archivo para subir.");
                return;
            }

            const code = await extractCodeFromPDF(file);

            try {
                const fileName = file.name;
                const storageRef = ref(storage, `uploads/${fileName}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                await addDoc(collection(db, "files"), {
                    name: fileName,
                    url: downloadURL,
                    code: code,
                    date: new Date().toLocaleDateString()
                });

                loadFiles();
                fileInput.value = "";
            } catch (error) {
                console.error("Error al subir el archivo:", error.message);
                alert("Error al subir el archivo: " + error.message);
            }
        });

        async function loadFiles() {
            const fileTableBody = document.getElementById("fileTableBody");
            fileTableBody.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, "files"));

            querySnapshot.forEach((doc) => {
                const fileData = doc.data();
                const row = document.createElement("tr");

                const titleCell = document.createElement("td");
                titleCell.textContent = fileData.name;

                const codeCell = document.createElement("td");
                codeCell.textContent = fileData.code || "C√≥digo no encontrado";

                const fileCell = document.createElement("td");
                if (fileData.url) {
                    const link = document.createElement("a");
                    link.href = fileData.url;
                    link.target = "_blank";
                    link.classList.add("file-link");
                    link.innerHTML = `<img src="https://img.icons8.com/ios-filled/50/000000/pdf.png" class="icon" /> Ver archivo`;
                    fileCell.appendChild(link);
                } else {
                    fileCell.textContent = "Sin Archivo";
                    fileCell.classList.add("no-file");
                }

                row.appendChild(titleCell);
                row.appendChild(codeCell);
                row.appendChild(fileCell);
                fileTableBody.appendChild(row);
            });
        }

        window.showListContent = function(type) {
            const listContent = document.getElementById("list-content");
            listContent.innerHTML = `
                <h3>${getListTitle(type)}</h3>
                <input type="file" id="fileInput-${type}" />
                <button class="button" onclick="uploadListFile('${type}')">Subir archivo</button>
                
                <table>
                    <thead>
                        <tr>
                            <th>T√≠tulo</th>
                            <th>C√≥digo</th>
                            <th>Archivo</th>
                        </tr>
                    </thead>
                    <tbody id="fileTableBody-${type}">
                    </tbody>
                </table>
            `;
            loadListFiles(type);
        };

        function getListTitle(type) {
            switch (type) {
                case 'documentada': return 'Informaci√≥n Documentada Mantenida';
                case 'externos': return 'Documentos Externos';
                case 'registros': return 'Registros';
                case 'perfil': return 'Perfil Funcional';
                case 'responsabilidades': return 'Responsabilidades';
                case 'Procesos': return 'Procesos';
                default: return 'Lista';
            }
        }

        // Define la funci√≥n como global para resolver el error de referencia
        window.uploadListFile = async function(type) {
            const fileInput = document.getElementById(`fileInput-${type}`);
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor seleccione un archivo para subir.");
                return;
            }

            const code = await extractCodeFromPDF(file);

            try {
                const fileName = file.name;
                const storageRef = ref(storage, `uploads/${type}/${fileName}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                await addDoc(collection(db, `files-${type}`), {
                    name: fileName,
                    url: downloadURL,
                    code: code,
                    date: new Date().toLocaleDateString()
                });

                loadListFiles(type);
                fileInput.value = "";
            } catch (error) {
                console.error("Error al subir el archivo:", error.message);
                alert("Error al subir el archivo: " + error.message);
            }
        };

        async function loadListFiles(type) {
            const fileTableBody = document.getElementById(`fileTableBody-${type}`);
            fileTableBody.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, `files-${type}`));

            querySnapshot.forEach((doc) => {
                const fileData = doc.data();
                const row = document.createElement("tr");

                const titleCell = document.createElement("td");
                titleCell.textContent = fileData.name;

                const codeCell = document.createElement("td");
                codeCell.textContent = fileData.code || "C√≥digo no encontrado";

                const fileCell = document.createElement("td");
                if (fileData.url) {
                    const link = document.createElement("a");
                    link.href = fileData.url;
                    link.target = "_blank";
                    link.classList.add("file-link");
                    link.innerHTML = `<img src="https://img.icons8.com/ios-filled/50/000000/pdf.png" class="icon" /> Ver archivo`;
                    fileCell.appendChild(link);
                } else {
                    fileCell.textContent = "Sin Archivo";
                    fileCell.classList.add("no-file");
                }

                row.appendChild(titleCell);
                row.appendChild(codeCell);
                row.appendChild(fileCell);
                fileTableBody.appendChild(row);
            });
        }

        document.getElementById('tab-home').addEventListener('click', () => {
            showTabContent('home');
        });

        document.getElementById('tab-lists').addEventListener('click', () => {
            showTabContent('lists');
        });

        document.getElementById('tab-files').addEventListener('click', () => {
            showTabContent('files');
        });

        document.getElementById('tab-settings').addEventListener('click', () => {
            showTabContent('settings');
    
        });

        function showTabContent(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            const tabs = document.querySelectorAll('.tabs div');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        loadFiles();

       document.getElementById("logout").addEventListener("click", () => {
    signOut(auth).then(() => {
        alert("Confirma cerrar sesi√≥n.");
        // Cambiar redirecci√≥n a la pantalla de creaci√≥n de cuenta e inicio de sesi√≥n
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('signin-screen').style.display = 'block';
         document.getElementById('info-container').style.display = 'block';
    }).catch((error) => {
        console.error("Error al cerrar sesi√≥n:", error);
    });
});

// Funci√≥n para cargar los datos del perfil del usuario
async function loadUserProfile() {
    const user = auth.currentUser;

    if (user) {
        const userRef = doc(db, "users", user.uid); // Aseg√∫rate de que los datos del usuario est√©n en la colecci√≥n "users"
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
            const userData = userDoc.data();
            document.getElementById("userName").textContent = userData.nombre;
            document.getElementById("userLastName").textContent = userData.apellido;
            document.getElementById("userRole").textContent = userData.rol;
            document.getElementById("userEmail").textContent = userData.email;

            document.getElementById("profileModal").style.display = "block";
        } else {
            alert("No se encontraron datos del usuario.");
        }
    } else {
        alert("No se ha iniciado sesi√≥n.");
    }
}

// Mostrar modal de perfil al hacer clic en "Ver mi perfil"
document.getElementById("viewProfile").addEventListener("click", loadUserProfile);

// Cerrar modal de perfil
document.getElementById("closeProfile").addEventListener("click", () => {
    document.getElementById("profileModal").style.display = "none";
});

// Cerrar modal al hacer clic fuera de √©l
window.addEventListener("click", (event) => {
    if (event.target == document.getElementById("profileModal")) {
        document.getElementById("profileModal").style.display = "none";
    }
});
   // Funcionalidad para el men√∫ de tres puntos
      document.addEventListener("DOMContentLoaded", () => {
            const threeDotsMenu = document.getElementById("threeDotsMenu");
            const threeDotsDropdown = document.getElementById("threeDotsDropdown");

            // Mostrar/ocultar el men√∫
            threeDotsMenu.addEventListener("click", (event) => {
                event.stopPropagation();
                const isVisible = threeDotsDropdown.style.display === "block";
                threeDotsDropdown.style.display = isVisible ? "none" : "block";
            });

            // Cerrar el men√∫ al hacer clic fuera
            window.addEventListener("click", () => {
                if (threeDotsDropdown.style.display === "block") {
                    threeDotsDropdown.style.display = "none";
                }
            });

            // Funcionalidad para "Otras Opciones"
             });
   document.getElementById("otherOptions").addEventListener("click", () => {
        const modal = `
            <div id="otherOptionsModal" class="modal" style="display: flex;">
                <div class="modal-content">
                    <span class="close" id="closeOtherOptions">&times;</span>
                    <h2>Otras Opciones</h2>
                    <ul>
                        <li>
                            <a href="https://ctalexander.github.io/entradas_y_salidas_2.0/" target="_blank">
                            
                                Entradas y Salidas
                            </a>
                        </li>
                        <li>
                            <a href="https://ctalexander.github.io/inventario-de-mps-/">
                                Inventario de Materias Primas
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML("beforeend", modal);

        // Cerrar modal
        document.getElementById("closeOtherOptions").addEventListener("click", () => {
            document.getElementById("otherOptionsModal").remove();
        });

        // Cerrar modal al hacer clic fuera de √©l
        window.addEventListener("click", (event) => {
            const modalElement = document.getElementById("otherOptionsModal");
            if (event.target === modalElement) {
                modalElement.remove();
            }
        });
    });

   //HACCP
   // Manejar el clic del bot√≥n
document.getElementById("btn-haccp").addEventListener("click", () => {
    // Referencia al archivo en Firebase Storage
    const fileRef = ref(storage, "Plan de An√°lisis de Peligros y Puntos Cr√≠ticos de Control (HACCP) OK.pdf");

    // Obt√©n la URL de descarga
    getDownloadURL(fileRef)
        .then((url) => {
            // Muestra el contenedor del PDF
            const pdfContainer = document.getElementById("pdf-container");
            pdfContainer.style.display = "block";

            // Establece la URL del PDF en el iframe
            const pdfViewer = document.getElementById("pdf-viewer");
            pdfViewer.src = url;
        })
        .catch((error) => {
            console.error("Error al obtener el archivo:", error);
   });
});


document.getElementById("btn-haccp").addEventListener("click", (event) => {
    event.stopPropagation(); // Previene que el clic cierre el contenedor
    // Resto del c√≥digo para mostrar el PDF

    // Selecciona el contenedor y el bot√≥n
const pdfContainer = document.getElementById("pdf-container");
const pdfViewer = document.getElementById("pdf-viewer");

// Funci√≥n para cerrar el contenedor al hacer clic fuera de √©l
document.addEventListener("click", (event) => {
    // Verifica si el clic ocurri√≥ fuera del contenedor del PDF
    if (
        pdfContainer.style.display === "block" && // Solo si el contenedor est√° visible
        !pdfContainer.contains(event.target) // Si el clic no es dentro del contenedor
    ) {
        pdfContainer.style.display = "none"; // Oculta el contenedor
        pdfViewer.src = ""; // Limpia el contenido del iframe
    }
});

});



     </script>
</body>
</html>

